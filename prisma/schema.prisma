generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["postgresqlExtensions"]
}

datasource db {
  provider   = "postgresql"
  url        = env("DATABASE_URL")
  extensions = [ltree, pgcrypto, timescaledb, uuid_ossp(map: "uuid-ossp")]
}

model Tenant {
  id                       String                   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  createdAt                DateTime                 @default(now()) @map("created_at")
  updatedAt                DateTime                 @updatedAt @map("updated_at")
  path                     String                   @unique
  name                     String
  parentId                 String?                  @map("parent_id") @db.Uuid
  contactFirstName         String?                  @map("contact_first_name")
  contactLastName          String?                  @map("contact_last_name")
  contactPhone             String?                  @map("contact_phone")
  contactEmail             String?                  @map("contact_email")
  taxId                    String?                  @map("tax_id")
  taxOffice                String?                  @map("tax_office")
  address                  Json?
  latitude                 Decimal?                 @db.Decimal(10, 8)
  longitude                Decimal?                 @db.Decimal(11, 8)
  tenantSubscriptionStatus TenantSubscriptionStatus @default(TRIAL) @map("tenant_subscription_status")
  subscriptionPlan         String?                  @map("subscription_plan")
  settings                 Json?
  path_ltree               Unsupported("ltree")?    @default(dbgenerated("(path)::ltree"))
  alarms                   Alarm[]
  customers                Customer[]
  devices                  Device[]
  meters                   Meter[]
  readings                 Reading[]
  subscriptions            Subscription[]
  parent                   Tenant?                  @relation("TenantHierarchy", fields: [parentId], references: [id])
  children                 Tenant[]                 @relation("TenantHierarchy")
  users                    UserTenant[]
  allowedDeviceProfiles    DeviceProfile[]          @relation("TenantAllowedDeviceProfiles")
  allowedProfiles          MeterProfile[]           @relation("TenantAllowedProfiles")

  @@index([path])
  @@index([parentId])
  @@map("tenants")
}

model User {
  id           String        @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  createdAt    DateTime      @default(now()) @map("created_at")
  updatedAt    DateTime      @updatedAt @map("updated_at")
  firstName    String        @map("first_name")
  lastName     String        @map("last_name")
  email        String        @unique
  phone        String?
  tcIdNo       String?       @map("tc_id_no")
  passwordHash String        @map("password_hash")
  isActive     Boolean       @default(true) @map("is_active")
  lastLoginAt  DateTime?     @map("last_login_at")
  lastLoginIp  String?       @map("last_login_ip")
  avatarUrl    String?       @map("avatar_url")
  language     String        @default("en")
  timezone     String        @default("UTC")
  metadata     Json?
  activityLogs ActivityLog[]
  tenants      UserTenant[]

  @@index([email])
  @@map("users")
}

model UserTenant {
  id          String     @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  createdAt   DateTime   @default(now()) @map("created_at")
  updatedAt   DateTime   @updatedAt @map("updated_at")
  userId      String     @map("user_id") @db.Uuid
  tenantId    String     @map("tenant_id") @db.Uuid
  role        SystemRole
  permissions String[]   @default([])
  tenant      Tenant     @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  user        User       @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, tenantId])
  @@index([tenantId])
  @@map("user_tenants")
}

model ActivityLog {
  id         String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  createdAt  DateTime @default(now()) @map("created_at")
  userId     String   @map("user_id") @db.Uuid
  action     String
  resource   String?
  resourceId String?  @map("resource_id")
  details    Json?
  ipAddress  String?  @map("ip_address")
  userAgent  String?  @map("user_agent")
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([createdAt])
  @@map("activity_logs")
}

model Customer {
  id             String         @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  createdAt      DateTime       @default(now()) @map("created_at")
  updatedAt      DateTime       @updatedAt @map("updated_at")
  tenantId       String         @map("tenant_id") @db.Uuid
  customerType   CustomerType   @map("customer_type")
  details        Json
  metadata       Json?
  customerNumber String         @map("customer_number")
  tenant         Tenant         @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  subscriptions  Subscription[]

  @@unique([tenantId, customerNumber])
  @@index([tenantId])
  @@index([customerType])
  @@index([customerNumber])
  @@map("customers")
}

model Subscription {
  id                 String            @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  createdAt          DateTime          @default(now()) @map("created_at")
  updatedAt          DateTime          @updatedAt @map("updated_at")
  tenantId           String            @map("tenant_id") @db.Uuid
  customerId         String            @map("customer_id") @db.Uuid
  subscriptionType   SubscriptionType  @map("subscription_type")
  subscriptionGroup  SubscriptionGroup @default(NORMAL_CONSUMPTION) @map("subscription_group")
  address            Json
  addressCode        String?           @map("address_code")
  latitude           Decimal?          @db.Decimal(10, 8)
  longitude          Decimal?          @db.Decimal(11, 8)
  isActive           Boolean           @default(true) @map("is_active")
  startDate          DateTime          @default(now()) @map("start_date")
  endDate            DateTime?         @map("end_date")
  metadata           Json?
  subscriptionNumber String            @map("subscription_number")
  meters             Meter[]
  customer           Customer          @relation(fields: [customerId], references: [id])
  tenant             Tenant            @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@unique([tenantId, subscriptionNumber])
  @@index([tenantId])
  @@index([customerId])
  @@index([isActive])
  @@index([subscriptionType])
  @@index([subscriptionNumber])
  @@map("subscriptions")
}

model DeviceProfile {
  id                      String                  @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  createdAt               DateTime                @default(now()) @map("created_at")
  updatedAt               DateTime                @updatedAt @map("updated_at")
  brand                   DeviceBrand
  modelCode               String                  @map("model_code")
  communicationTechnology CommunicationTechnology @map("communication_technology")
  integrationType         IntegrationType         @default(HTTP) @map("integration_type")
  fieldDefinitions        Json                    @default("[]") @map("field_definitions")
  decoderFunction         String?                 @map("decoder_function")
  testPayload             String?                 @map("test_payload")
  expectedOutput          Json?                   @map("expected_output")
  lastTestedAt            DateTime?               @map("last_tested_at")
  lastTestSucceeded       Boolean?                @map("last_test_succeeded")
  batteryLifeMonths       Int?                    @map("battery_life_months")
  specifications          Json?
  devices                 Device[]
  compatibleMeterProfiles MeterProfile[]          @relation("CompatibleDeviceProfiles")
  allowedTenants          Tenant[]                @relation("TenantAllowedDeviceProfiles")

  @@unique([brand, modelCode])
  @@index([brand])
  @@index([communicationTechnology])
  @@map("device_profiles")
}

model Device {
  id                  String        @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  createdAt           DateTime      @default(now()) @map("created_at")
  updatedAt           DateTime      @updatedAt @map("updated_at")
  tenantId            String        @map("tenant_id") @db.Uuid
  deviceProfileId     String        @map("device_profile_id") @db.Uuid
  serialNumber        String        @unique @map("serial_number")
  status              DeviceStatus  @default(WAREHOUSE)
  dynamicFields       Json          @default("{}") @map("dynamic_fields")
  lastSignalStrength  Int?          @map("last_signal_strength")
  lastBatteryLevel    Int?          @map("last_battery_level")
  lastCommunicationAt DateTime?     @map("last_communication_at")
  metadata            Json?
  deviceProfile       DeviceProfile @relation(fields: [deviceProfileId], references: [id])
  tenant              Tenant        @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  meter               Meter?

  @@index([tenantId])
  @@index([deviceProfileId])
  @@index([status])
  @@index([serialNumber])
  @@map("devices")
}

model MeterProfile {
  id                       String              @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  createdAt                DateTime            @default(now()) @map("created_at")
  updatedAt                DateTime            @updatedAt @map("updated_at")
  brand                    Brand
  modelCode                String              @map("model_code")
  meterType                MeterType           @map("meter_type")
  dialType                 DialType            @map("dial_type")
  connectionType           ConnectionType      @map("connection_type")
  mountingType             MountingType        @map("mounting_type")
  temperatureType          TemperatureType     @map("temperature_type")
  diameter                 Int?
  length                   Int?
  width                    Int?
  height                   Int?
  q1                       Decimal?            @db.Decimal(10, 4)
  q2                       Decimal?            @db.Decimal(10, 4)
  q3                       Decimal?            @db.Decimal(10, 4)
  q4                       Decimal?            @db.Decimal(10, 4)
  rValue                   Decimal?            @map("r_value") @db.Decimal(10, 2)
  pressureLoss             Decimal?            @map("pressure_loss") @db.Decimal(10, 4)
  ipRating                 IPRating?           @map("ip_rating")
  communicationModule      CommunicationModule @default(NONE) @map("communication_module")
  specifications           Json?
  meters                   Meter[]
  compatibleDeviceProfiles DeviceProfile[]     @relation("CompatibleDeviceProfiles")
  allowedTenants           Tenant[]            @relation("TenantAllowedProfiles")

  @@unique([brand, modelCode])
  @@index([brand])
  @@index([meterType])
  @@map("meter_profiles")
}

model Meter {
  id               String        @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  createdAt        DateTime      @default(now()) @map("created_at")
  updatedAt        DateTime      @updatedAt @map("updated_at")
  tenantId         String        @map("tenant_id") @db.Uuid
  meterProfileId   String        @map("meter_profile_id") @db.Uuid
  activeDeviceId   String?       @unique @map("active_device_id") @db.Uuid
  serialNumber     String        @unique @map("serial_number")
  initialIndex     Decimal       @default(0) @map("initial_index") @db.Decimal(15, 3)
  installationDate DateTime      @map("installation_date")
  status           MeterStatus   @default(WAREHOUSE)
  valveStatus      ValveStatus   @default(NOT_APPLICABLE) @map("valve_status")
  lastReadingValue Decimal?      @map("last_reading_value") @db.Decimal(15, 3)
  lastReadingTime  DateTime?     @map("last_reading_time")
  metadata         Json?
  subscriptionId   String?       @map("subscription_id") @db.Uuid
  alarms           Alarm[]
  activeDevice     Device?       @relation(fields: [activeDeviceId], references: [id])
  meterProfile     MeterProfile  @relation(fields: [meterProfileId], references: [id])
  subscription     Subscription? @relation(fields: [subscriptionId], references: [id])
  tenant           Tenant        @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  readings         Reading[]

  @@index([tenantId])
  @@index([subscriptionId])
  @@index([status])
  @@index([serialNumber])
  @@map("meters")
}

model Reading {
  id                      String                   @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  time                    DateTime                 @default(now()) @db.Timestamptz(6)
  tenantId                String                   @map("tenant_id") @db.Uuid
  meterId                 String                   @map("meter_id") @db.Uuid
  value                   Decimal                  @db.Decimal(15, 3)
  consumption             Decimal                  @db.Decimal(15, 3)
  unit                    String                   @default("m3")
  signalStrength          Int?                     @map("signal_strength")
  batteryLevel            Int?                     @map("battery_level")
  temperature             Decimal?                 @db.Decimal(5, 2)
  rawPayload              Json?                    @map("raw_payload")
  source                  String?                  @map("source")
  communicationTechnology CommunicationTechnology? @map("communication_technology")
  processedAt             DateTime?                @map("processed_at") @db.Timestamptz(6)
  decoderUsed             String?                  @map("decoder_used")
  sourceDeviceId          String?                  @map("source_device_id") @db.Uuid
  meter                   Meter                    @relation(fields: [meterId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  tenant                  Tenant                   @relation(fields: [tenantId], references: [id], onDelete: NoAction, onUpdate: NoAction)

  @@id([id, time])
  @@index([time(sort: Desc)])
  @@index([meterId, time(sort: Desc)])
  @@index([tenantId, time(sort: Desc)])
  @@map("readings")
}

model Alarm {
  id             String      @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  createdAt      DateTime    @default(now()) @map("created_at")
  updatedAt      DateTime    @updatedAt @map("updated_at")
  tenantId       String      @map("tenant_id") @db.Uuid
  meterId        String      @map("meter_id") @db.Uuid
  type           AlarmType
  status         AlarmStatus @default(ACTIVE)
  severity       Int         @default(1)
  message        String?
  details        Json?
  acknowledgedAt DateTime?   @map("acknowledged_at")
  acknowledgedBy String?     @map("acknowledged_by") @db.Uuid
  resolvedAt     DateTime?   @map("resolved_at")
  resolvedBy     String?     @map("resolved_by") @db.Uuid
  resolution     String?
  meter          Meter       @relation(fields: [meterId], references: [id], onDelete: Cascade)
  tenant         Tenant      @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([meterId])
  @@index([status])
  @@index([createdAt])
  @@map("alarms")
}

model Setting {
  id        String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")
  tenantId  String?  @map("tenant_id") @db.Uuid
  key       String
  value     Json
  category  String?

  @@unique([tenantId, key])
  @@index([category])
  @@map("settings")
}

model CommunicationTechFieldDef {
  id               String                  @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  createdAt        DateTime                @default(now()) @map("created_at")
  updatedAt        DateTime                @updatedAt @map("updated_at")
  technology       CommunicationTechnology @unique
  fields           Json
  integrationTypes IntegrationType[]       @default([]) @map("integration_types")

  @@map("communication_tech_field_defs")
}

model RefreshToken {
  id        String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  createdAt DateTime  @default(now()) @map("created_at")
  userId    String    @map("user_id") @db.Uuid
  token     String    @unique
  expiresAt DateTime  @map("expires_at")
  revokedAt DateTime? @map("revoked_at")
  userAgent String?   @map("user_agent")
  ipAddress String?   @map("ip_address")

  @@index([userId])
  @@index([token])
  @@map("refresh_tokens")
}

enum SubscriptionType {
  INDIVIDUAL
  ORGANIZATIONAL
}

enum SubscriptionGroup {
  NORMAL_CONSUMPTION
  HIGH_CONSUMPTION
}

enum MeterType {
  SINGLE_JET
  MULTI_JET
  WOLTMAN_PARALEL
  WOLTMAN_VERTICAL
  VOLUMETRIC
  ULTRASONIC
  ELECTROMAGNETIC
  COMPOUND
  IRRIGATION
}

enum DialType {
  SEMI_DRY
  DRY
  SUPER_DRY
  WET
}

enum TemperatureType {
  T30
  T90
}

enum MountingType {
  VERTICAL
  HORIZONTAL
  BOTH
}

enum ConnectionType {
  THREAD
  FLANGE
}

enum CommunicationModule {
  INTEGRATED
  RETROFIT
  NONE
}

enum Brand {
  BAYLAN
  MANAS
  KLEPSAN
  CEM
  ZENNER
  TURKOGLU
  BEREKET
  TEKSAN
  ITRON
  IMA
  CODIGNO
}

enum DeviceBrand {
  UNA
  IMA
  ITRON
  ZENNER
  MANAS
  BAYLAN
  CEM
  KLEPSAN
  CODIGNO
  INODYA
}

enum CommunicationTechnology {
  SIGFOX
  LORAWAN
  NB_IOT
  WM_BUS
  MIOTY
  WIFI
  BLUETOOTH
  NFC
  OMS
}

enum IntegrationType {
  HTTP
  MQTT
  API
}

enum CustomerType {
  INDIVIDUAL
  ORGANIZATIONAL
}

enum MeterStatus {
  ACTIVE
  PASSIVE
  WAREHOUSE
  MAINTENANCE
  PLANNED
  DEPLOYED
  USED
}

enum DeviceStatus {
  ACTIVE
  PASSIVE
  WAREHOUSE
  MAINTENANCE
  PLANNED
  DEPLOYED
  USED
}

enum IPRating {
  IP54
  IP65
  IP67
  IP68
}

enum SystemRole {
  PLATFORM_ADMIN
  TENANT_ADMIN
  OPERATOR
  VIEWER
  FIELD_ENGINEER
  CUSTOMER
}

enum AlarmType {
  TAMPER
  LOW_BATTERY
  TILT
  REVERSE_FLOW
  HIGH_USAGE
  NO_SIGNAL
  VALVE_ERROR
  COMMUNICATION_ERROR
}

enum AlarmStatus {
  ACTIVE
  ACKNOWLEDGED
  RESOLVED
}

enum TenantSubscriptionStatus {
  ACTIVE
  PASSIVE
  TRIAL
  SUSPENDED
}

enum ValveStatus {
  OPEN
  CLOSED
  UNKNOWN
  NOT_APPLICABLE
}
